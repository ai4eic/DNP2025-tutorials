
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Data Generation &#8212; Deep Learning Tutorials for Nuclear Physics at APS-DNP 2025</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/02-cnn-regression';</script>
    <link rel="canonical" href="https://ai4eic.github.io/DNP2025-tutorials/notebooks/02-cnn-regression.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="GAN Generation" href="03-gan-generation.html" />
    <link rel="prev" title="CNN for FCAL Shower Classification" href="02-cnn-classification.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../landing_page.html">
  
  
  
  
  
  
    <p class="title logo__title">Deep Learning Tutorials for Nuclear Physics at APS-DNP 2025</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../chapters/01-intro-to-gluex.html">Introduction to GlueX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chapters/01-intro-to-fcal.html">Introduction to FCAL</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">CNN for FCAL</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../chapters/02-problem-description.html">Problem Formulation</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.google.com/presentation/d/1Bd6isqCNZgUn0Mho43jsID-rZDn7fHWo3y0gd4ngI8Q/edit?usp=drive_link">Lecture -- CNN Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="02-dataset-preparation.html">Data Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="02-cnn-classification.html">CNN for FCAL Shower Classification</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Data Generation</a></li>




</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Generative AI for FCAL</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="03-gan-generation.html">GAN Generation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="CNN_DNP2025_01.html">Primer for CNN using `PyTorch`</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ai4eic/DNP2025-tutorials" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ai4eic/DNP2025-tutorials/edit/main/notebooks/02-cnn-regression.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ai4eic/DNP2025-tutorials/issues/new?title=Issue%20on%20page%20%2Fnotebooks/02-cnn-regression.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/02-cnn-regression.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Data Generation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Data Generation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#fcalshowers-tree">FCALShowers tree</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#looking-at-distributions">Looking at distributions</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#distinguishing-split-offs-from-photons">Distinguishing Split-offs from Photons</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#regression">Regression</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-the-classifier-build-dataset-of-predicted-photons">Apply the classifier – build dataset of predicted photons</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#truth-matched-photons-and-purity">Truth-matched photons and purity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-regressor-on-all-truth-photons">Train Regressor on all Truth Photons</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deploy-regressor-on-dataset-1-showers-classified-as-photons-and-dataset-2-true-photons-and-plot-reconstructed-energy">Deploy Regressor on Dataset 1 (showers classified as photons) and Dataset 2 (true photons) and Plot Reconstructed Energy</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="data-generation">
<h1>Data Generation<a class="headerlink" href="#data-generation" title="Link to this heading">#</a></h1>
<p>I used a particle gun of the following setting to generate this dataset.
The dataset is found in <a class="reference external" href="https://drive.google.com/file/d/1BW3m7Gy41jBSJpba4oh--Y33wsqzbbvI/view?usp=sharing">google drive</a></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>particle name</p></th>
<th class="head"><p>momentum range [GeV]</p></th>
<th class="head"><p>theta (<span class="math notranslate nohighlight">\(\theta\)</span>) range [deg]</p></th>
<th class="head"><p>phi (<span class="math notranslate nohighlight">\(\phi\)</span>) range [deg]</p></th>
<th class="head"><p>No Of Events</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(\gamma\)</span></p></td>
<td><p>0.1 - 4.0</p></td>
<td><p>1 - 11</p></td>
<td><p>0 - 360</p></td>
<td><p>500k</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(\pi^{+}\)</span></p></td>
<td><p>0.1 - 4.0</p></td>
<td><p>1 - 11</p></td>
<td><p>0 - 360</p></td>
<td><p>250k</p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(\pi^{-}\)</span></p></td>
<td><p>0.1 - 4.0</p></td>
<td><p>1 - 10</p></td>
<td><p>0 - 360</p></td>
<td><p>250k</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="fcalshowers-tree">
<h1>FCALShowers tree<a class="headerlink" href="#fcalshowers-tree" title="Link to this heading">#</a></h1>
<p>In this tree, I run the clustering algorithm along with all corrections (nonlinear energy and position correction from cluster to shower).</p>
<p>Then I match the reconstructed shower which matches the thrown information</p>
<ol class="arabic simple">
<li><p>If the thrown shower is charged, then I only perform geometrical matching,</p></li>
<li><p>If the thrown shower is neutral, then I perform geometrical as well as energy matching.</p></li>
</ol>
<p>Any showers that are not matched to the thrown is marked as split off. So for each event you can see there could be multiple showers that are reconstructed. Only one of the event is matched (isChargedShower, isNeutralShower), if they are not matched then it is marked as (isSplitOff). So a classification problem could be, given a shower, mark it as charged, neutral or splitoff.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="n">uproot</span> <span class="n">awkward</span><span class="o">-</span><span class="n">pandas</span> <span class="n">pandas</span> <span class="n">matplotlib</span> <span class="n">seaborn</span> <span class="n">vector</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Collecting uproot
  Downloading uproot-5.6.6-py3-none-any.whl.metadata (34 kB)
Collecting awkward-pandas
  Downloading awkward_pandas-2023.8.0-py3-none-any.whl.metadata (2.1 kB)
Requirement already satisfied: pandas in /usr/local/lib/python3.12/dist-packages (2.2.2)
Requirement already satisfied: matplotlib in /usr/local/lib/python3.12/dist-packages (3.10.0)
Requirement already satisfied: seaborn in /usr/local/lib/python3.12/dist-packages (0.13.2)
Collecting vector
  Downloading vector-1.6.3-py3-none-any.whl.metadata (16 kB)
Collecting awkward&gt;=2.4.6 (from uproot)
  Downloading awkward-2.8.9-py3-none-any.whl.metadata (7.5 kB)
Requirement already satisfied: cramjam&gt;=2.5.0 in /usr/local/lib/python3.12/dist-packages (from uproot) (2.11.0)
Requirement already satisfied: fsspec!=2025.7.0 in /usr/local/lib/python3.12/dist-packages (from uproot) (2025.3.0)
Requirement already satisfied: numpy in /usr/local/lib/python3.12/dist-packages (from uproot) (2.0.2)
Requirement already satisfied: packaging in /usr/local/lib/python3.12/dist-packages (from uproot) (25.0)
Requirement already satisfied: xxhash in /usr/local/lib/python3.12/dist-packages (from uproot) (3.6.0)
Requirement already satisfied: python-dateutil&gt;=2.8.2 in /usr/local/lib/python3.12/dist-packages (from pandas) (2.9.0.post0)
Requirement already satisfied: pytz&gt;=2020.1 in /usr/local/lib/python3.12/dist-packages (from pandas) (2025.2)
Requirement already satisfied: tzdata&gt;=2022.7 in /usr/local/lib/python3.12/dist-packages (from pandas) (2025.2)
Requirement already satisfied: contourpy&gt;=1.0.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib) (1.3.3)
Requirement already satisfied: cycler&gt;=0.10 in /usr/local/lib/python3.12/dist-packages (from matplotlib) (0.12.1)
Requirement already satisfied: fonttools&gt;=4.22.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib) (4.60.1)
Requirement already satisfied: kiwisolver&gt;=1.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib) (1.4.9)
Requirement already satisfied: pillow&gt;=8 in /usr/local/lib/python3.12/dist-packages (from matplotlib) (11.3.0)
Requirement already satisfied: pyparsing&gt;=2.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib) (3.2.5)
Collecting awkward-cpp==50 (from awkward&gt;=2.4.6-&gt;uproot)
  Downloading awkward_cpp-50-cp312-cp312-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl.metadata (2.2 kB)
Requirement already satisfied: six&gt;=1.5 in /usr/local/lib/python3.12/dist-packages (from python-dateutil&gt;=2.8.2-&gt;pandas) (1.17.0)
Downloading uproot-5.6.6-py3-none-any.whl (385 kB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">385.7/385.7 kB</span> <span class=" -Color -Color-Red">7.1 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading awkward_pandas-2023.8.0-py3-none-any.whl (11 kB)
Downloading vector-1.6.3-py3-none-any.whl (179 kB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">179.6/179.6 kB</span> <span class=" -Color -Color-Red">4.2 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading awkward-2.8.9-py3-none-any.whl (903 kB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">903.5/903.5 kB</span> <span class=" -Color -Color-Red">16.6 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hDownloading awkward_cpp-50-cp312-cp312-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl (655 kB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ <span class=" -Color -Color-Green">655.9/655.9 kB</span> <span class=" -Color -Color-Red">14.6 MB/s</span> eta <span class=" -Color -Color-Cyan">0:00:00</span>
?25hInstalling collected packages: vector, awkward-cpp, awkward, uproot, awkward-pandas
Successfully installed awkward-2.8.9 awkward-cpp-50 awkward-pandas-2023.8.0 uproot-5.6.6 vector-1.6.3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">drive</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># Mount Google Drive</span>
<span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/content/drive&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mounted at /content/drive
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_path</span> <span class="o">=</span> <span class="s2">&quot;/content/drive/MyDrive/DNP-2025/ParticleGun/ParticleGunFulDataSet_1Mevents_shuffled.root&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lets look into the ALLFCALHits tree of the files,</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uproot</span><span class="o">,</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span><span class="o">,</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">dataset_tree</span> <span class="o">=</span> <span class="n">uproot</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">)[</span><span class="s2">&quot;FCALShowers&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">dataset_tree</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">branch</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="n">branch</span><span class="o">.</span><span class="n">typename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>thrownPID of type int32_t
thrownEnergy of type double
thrownPosition_fX of type double
thrownPosition_fY of type double
thrownPosition_fZ of type double
thrownMomentum_fX of type double
thrownMomentum_fY of type double
thrownMomentum_fZ of type double
thrownMass of type double
numBlocks of type int32_t
isNearBorder of type bool
showerE of type double
showerPos_fX of type double
showerPos_fY of type double
showerPos_fZ of type double
sumU of type double
sumV of type double
E9E25 of type double
E1E9 of type double
nrows of type int32_t
rows of type int32_t[]
ncols of type int32_t
cols of type int32_t[]
nenergies of type int32_t
energies of type double[]
isSplitOff of type bool
isChargedShower of type bool
isNeutralShower of type bool
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_tree</span> <span class="o">=</span> <span class="n">uproot</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;filtered_FCALShowers.root&quot;</span><span class="p">)[</span><span class="s2">&quot;FCALShowers&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">branch</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="n">branch</span><span class="o">.</span><span class="n">typename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>thrownPID of type int32_t
thrownEnergy of type double
thrownPosition_fX of type double
thrownPosition_fY of type double
thrownPosition_fZ of type double
thrownMomentum_fX of type double
thrownMomentum_fY of type double
thrownMomentum_fZ of type double
thrownMass of type double
numBlocks of type int32_t
isNearBorder of type bool
showerE of type double
showerPos_fX of type double
showerPos_fY of type double
showerPos_fZ of type double
sumU of type double
sumV of type double
E9E25 of type double
E1E9 of type double
nrows of type int32_t
rows of type int32_t[]
ncols of type int32_t
cols of type int32_t[]
nenergies of type int32_t
energies of type double[]
isSplitOff of type bool
isNeutralShower of type bool
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">arrays</span><span class="p">(</span><span class="n">library</span> <span class="o">=</span> <span class="s2">&quot;ak&quot;</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>814151
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">=</span> <span class="n">dataset_tree</span><span class="o">.</span><span class="n">arrays</span><span class="p">(</span><span class="n">library</span> <span class="o">=</span> <span class="s2">&quot;ak&quot;</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="s2">&quot;isChargedShower&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">filtered</span>  <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">fields_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filtered</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;E1E9&quot;</span><span class="p">,</span> <span class="s2">&quot;E9E25&quot;</span><span class="p">,</span> <span class="s2">&quot;sumU&quot;</span><span class="p">,</span> <span class="s2">&quot;sumV&quot;</span><span class="p">,</span> <span class="s2">&quot;isChargedShower&quot;</span><span class="p">]]</span>
<span class="n">filtered</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[</span><span class="n">fields_to_keep</span><span class="p">]</span>

<span class="n">output_path</span> <span class="o">=</span> <span class="s2">&quot;filtered_FCALShowers.root&quot;</span>

<span class="k">with</span> <span class="n">uproot</span><span class="o">.</span><span class="n">recreate</span><span class="p">(</span><span class="s2">&quot;filtered_FCALShowers.root&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">mktree</span><span class="p">(</span><span class="s2">&quot;FCALShowers&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">filtered</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filtered</span><span class="o">.</span><span class="n">fields</span><span class="p">})</span>
    <span class="n">fout</span><span class="p">[</span><span class="s2">&quot;FCALShowers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span>


</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">branches</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;thrownPID&quot;</span><span class="p">,</span> <span class="s2">&quot;thrownEnergy&quot;</span><span class="p">,</span> <span class="s2">&quot;thrownMass&quot;</span><span class="p">,</span> <span class="s2">&quot;showerE&quot;</span><span class="p">,</span> <span class="s2">&quot;rows&quot;</span><span class="p">,</span> <span class="s2">&quot;cols&quot;</span><span class="p">,</span> <span class="s2">&quot;energies&quot;</span><span class="p">,</span> <span class="s2">&quot;isSplitOff&quot;</span><span class="p">,</span> <span class="s2">&quot;isNeutralShower&quot;</span><span class="p">,</span><span class="s2">&quot;E1E9&quot;</span><span class="p">,</span><span class="s2">&quot;E9E25&quot;</span><span class="p">,</span><span class="s2">&quot;sumU&quot;</span><span class="p">,</span><span class="s2">&quot;sumV&quot;</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">dataset_tree</span><span class="o">.</span><span class="n">arrays</span><span class="p">(</span><span class="n">branches</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="s2">&quot;pd&quot;</span><span class="p">)</span>

<span class="n">n_photons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;isNeutralShower&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span>
<span class="n">n_splitOffs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;isSplitOff&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">])</span>

<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of photons: </span><span class="si">{</span><span class="n">n_photons</span><span class="si">:</span><span class="s2">2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of n_splitOffs: </span><span class="si">{</span><span class="n">n_splitOffs</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of photons: 4.348450e+05
Number of n_splitOffs: 3.79e+05
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lets compute E1/E9 by hand</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_patch</span><span class="p">(</span><span class="n">evnt</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">))</span>
    <span class="n">half</span> <span class="o">=</span> <span class="n">patch_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">evnt</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span>
    <span class="n">center_r</span><span class="p">,</span> <span class="n">center_c</span> <span class="o">=</span> <span class="n">evnt</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">idx_max</span><span class="p">],</span> <span class="n">evnt</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
    <span class="n">m_rows</span> <span class="o">=</span> <span class="n">evnt</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="n">center_r</span> <span class="o">+</span> <span class="n">half</span>
    <span class="n">m_cols</span> <span class="o">=</span> <span class="n">evnt</span><span class="o">.</span><span class="n">cols</span> <span class="o">-</span> <span class="n">center_c</span> <span class="o">+</span> <span class="n">half</span>
    <span class="n">m</span><span class="p">[</span><span class="n">m_rows</span><span class="p">,</span> <span class="n">m_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">evnt</span><span class="o">.</span><span class="n">energies</span>
    <span class="k">return</span> <span class="n">m</span>


<span class="n">df</span><span class="p">[</span><span class="s2">&quot;patches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">make_patch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[12, 13, 13]
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">/tmp/ipython-input-333330656.py</span> in <span class="ni">&lt;cell line: 0&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> 
<span class="g g-Whitespace">     </span><span class="mi">14</span> 
<span class="ne">---&gt; </span><span class="mi">15</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;patches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">make_patch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/pandas/core/frame.py</span> in <span class="ni">apply</span><span class="nt">(self, func, axis, raw, result_type, args, by_row, engine, engine_kwargs, **kwargs)</span>
<span class="g g-Whitespace">  </span><span class="mi">10372</span>             <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">  </span><span class="mi">10373</span>         <span class="p">)</span>
<span class="ne">&gt; </span><span class="mi">10374</span>         <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span><span class="o">.</span><span class="n">__finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;apply&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">  </span><span class="mi">10375</span> 
<span class="g g-Whitespace">  </span><span class="mi">10376</span>     <span class="k">def</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/pandas/core/apply.py</span> in <span class="ni">apply</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">914</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_raw</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">engine_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine_kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">915</span> 
<span class="ne">--&gt; </span><span class="mi">916</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_standard</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">917</span> 
<span class="g g-Whitespace">    </span><span class="mi">918</span>     <span class="k">def</span><span class="w"> </span><span class="nf">agg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/pandas/core/apply.py</span> in <span class="ni">apply_standard</span><span class="nt">(self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1061</span>     <span class="k">def</span><span class="w"> </span><span class="nf">apply_standard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1062</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">==</span> <span class="s2">&quot;python&quot;</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1063</span>             <span class="n">results</span><span class="p">,</span> <span class="n">res_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_series_generator</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1064</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1065</span>             <span class="n">results</span><span class="p">,</span> <span class="n">res_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_series_numba</span><span class="p">()</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/pandas/core/apply.py</span> in <span class="ni">apply_series_generator</span><span class="nt">(self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1079</span>             <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">series_gen</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1080</span>                 <span class="c1"># ignore SettingWithCopy here in case the user mutates</span>
<span class="ne">-&gt; </span><span class="mi">1081</span>                 <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1082</span>                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ABCSeries</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1083</span>                     <span class="c1"># If we have a view on v, we need to make a copy because</span>

<span class="nn">/tmp/ipython-input-333330656.py</span> in <span class="ni">make_patch</span><span class="nt">(evnt, patch_size)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">center_r</span><span class="p">,</span> <span class="n">center_c</span> <span class="o">=</span> <span class="n">evnt</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">idx_max</span><span class="p">],</span> <span class="n">evnt</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="nb">print</span> <span class="p">(</span><span class="n">evnt</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">9</span>     <span class="n">m_rows</span> <span class="o">=</span> <span class="n">evnt</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="n">center_r</span> <span class="o">+</span> <span class="n">half</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>     <span class="n">m_cols</span> <span class="o">=</span> <span class="n">evnt</span><span class="o">.</span><span class="n">cols</span> <span class="o">-</span> <span class="n">center_c</span> <span class="o">+</span> <span class="n">half</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>     <span class="n">m</span><span class="p">[</span><span class="n">m_rows</span><span class="p">,</span> <span class="n">m_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">evnt</span><span class="o">.</span><span class="n">energies</span>

<span class="ne">TypeError</span>: unsupported operand type(s) for -: &#39;list&#39; and &#39;int&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">rows</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rows</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>[12, 13, 13]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>[23, 24, 23, 24, 22]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>[28, 27, 27]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>[3, 2, 2]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>[13, 14, 12]</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>814146</th>
      <td>[45, 44, 45]</td>
    </tr>
    <tr>
      <th>814147</th>
      <td>[32, 33, 32, 33]</td>
    </tr>
    <tr>
      <th>814148</th>
      <td>[53, 52, 53, 54, 52, 53, 54, 51, 54, 52, 55, 53]</td>
    </tr>
    <tr>
      <th>814149</th>
      <td>[31, 32, 32, 33, 31, 32, 30]</td>
    </tr>
    <tr>
      <th>814150</th>
      <td>[17, 18, 17, 16, 17, 16, 18, 16, 18, 15, 17]</td>
    </tr>
  </tbody>
</table>
<p>814151 rows × 1 columns</p>
</div><br><label><b>dtype:</b> awkward</label></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_patches_vectorized</span><span class="p">(</span><span class="n">rows_list</span><span class="p">,</span> <span class="n">cols_list</span><span class="p">,</span> <span class="n">energies_list</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
    <span class="n">n_showers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows_list</span><span class="p">)</span>
    <span class="n">max_hits</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows_list</span><span class="p">)</span>
    <span class="n">half</span> <span class="o">=</span> <span class="n">patch_size</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="c1"># Pad all to same length</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_showers</span><span class="p">,</span> <span class="n">max_hits</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_showers</span><span class="p">,</span> <span class="n">max_hits</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_showers</span><span class="p">,</span> <span class="n">max_hits</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_showers</span><span class="p">,</span> <span class="n">max_hits</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rows_list</span><span class="p">,</span> <span class="n">cols_list</span><span class="p">,</span> <span class="n">energies_list</span><span class="p">)):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
        <span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Find center of each shower (max energy cell)</span>
    <span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">centers_r</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_showers</span><span class="p">),</span> <span class="n">idx_max</span><span class="p">]</span>
    <span class="n">centers_c</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_showers</span><span class="p">),</span> <span class="n">idx_max</span><span class="p">]</span>

    <span class="c1"># Compute relative coordinates for all hits</span>
    <span class="n">rel_r</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">-</span> <span class="n">centers_r</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">half</span>
    <span class="n">rel_c</span> <span class="o">=</span> <span class="n">cols</span> <span class="o">-</span> <span class="n">centers_c</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">half</span>

    <span class="c1"># Keep only hits that fall within the 11x11 window</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">mask</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">rel_r</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">rel_r</span> <span class="o">&lt;</span> <span class="n">patch_size</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">rel_c</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">rel_c</span> <span class="o">&lt;</span> <span class="n">patch_size</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Now build all patches (vectorized accumulation)</span>
    <span class="n">patches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_showers</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="c1"># Flatten for easy advanced indexing</span>
    <span class="n">shower_idx</span><span class="p">,</span> <span class="n">hit_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span>
    <span class="n">rr</span> <span class="o">=</span> <span class="n">rel_r</span><span class="p">[</span><span class="n">shower_idx</span><span class="p">,</span> <span class="n">hit_idx</span><span class="p">]</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">rel_c</span><span class="p">[</span><span class="n">shower_idx</span><span class="p">,</span> <span class="n">hit_idx</span><span class="p">]</span>
    <span class="n">ee</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="n">shower_idx</span><span class="p">,</span> <span class="n">hit_idx</span><span class="p">]</span>

    <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">patches</span><span class="p">,</span> <span class="p">(</span><span class="n">shower_idx</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">cc</span><span class="p">),</span> <span class="n">ee</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">patches</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">patches</span> <span class="o">=</span> <span class="n">make_patches_vectorized</span><span class="p">(</span>
    <span class="n">rows_list</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">],</span>
    <span class="n">cols_list</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;cols&quot;</span><span class="p">],</span>
    <span class="n">energies_list</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">patches</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c1"># -&gt; (nShowers, 11, 11)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(814151, 11, 11)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">df</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;isNeutralShower&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;isSplitOff&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;isNeutralShower&quot;</span><span class="p">,</span> <span class="s2">&quot;isSplitOff&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        isNeutralShower  isSplitOff  label
814131             True       False      1
814132             True       False      1
814133            False        True      0
814134             True       False      1
814135            False        True      0
814136             True       False      1
814137            False        True      0
814138             True       False      1
814139             True       False      1
814140             True       False      1
814141             True       False      1
814142             True       False      1
814143             True       False      1
814144             True       False      1
814145             True       False      1
814146            False        True      0
814147            False        True      0
814148             True       False      1
814149            False        True      0
814150             True       False      1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">patches</span><span class="p">[</span><span class="mi">1105</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b330af263e7c20d472c00f21b154748504dd831de54cd383c3b210c23a050f88.png" src="../_images/b330af263e7c20d472c00f21b154748504dd831de54cd383c3b210c23a050f88.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Assume these already exist:</span>
<span class="c1"># patches: shape (N, 11, 11)</span>
<span class="c1"># labels:  shape (N,)          -&gt; e.g., 0 for photon, 1 for splitOff</span>
<span class="c1"># showerE: shape (N,)</span>
<span class="c1"># thrownE: shape (N,)</span>

<span class="n">output_path</span> <span class="o">=</span> <span class="s2">&quot;FCAL_patches_dataset.h5&quot;</span>

<span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="c1"># Create datasets</span>
    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;patches&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span> <span class="n">compression_opts</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;showerE&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;showerE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;thrownE&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;thrownEnergy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

    <span class="c1"># Add some metadata</span>
    <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GlueX FCAL 11x11 patches centered on max-energy cell&quot;</span>
    <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;label_mapping&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;{0: splitOff, 1: photon}&quot;</span>
    <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;patch_shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Saved dataset with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">patches</span><span class="p">)</span><span class="si">}</span><span class="s2"> entries to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Saved dataset with 814151 entries to FCAL_patches_dataset.h5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">!</span><span class="n">ls</span> <span class="o">-</span><span class="n">lhtr</span> <span class="n">FCAL_patches_dataset</span><span class="o">.</span><span class="n">h5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-rw-r--r-- 1 root root 29M Oct 14 01:47 FCAL_patches_dataset.h5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">njit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="nd">@njit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make_patch_numba</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">half</span> <span class="o">=</span> <span class="n">patch_size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
    <span class="n">center_r</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
    <span class="n">center_c</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">center_r</span> <span class="o">+</span> <span class="n">half</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">center_c</span> <span class="o">+</span> <span class="n">half</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">lr</span> <span class="o">&lt;</span> <span class="n">patch_size</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">lc</span> <span class="o">&lt;</span> <span class="n">patch_size</span><span class="p">:</span>
            <span class="n">m</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">lr</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">e</span>
    <span class="k">return</span> <span class="n">m</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<span class="n">patches</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">8</span><span class="p">)(</span>
    <span class="n">delayed</span><span class="p">(</span><span class="n">make_patch_numba</span><span class="p">)(</span><span class="n">evnt</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">evnt</span><span class="o">.</span><span class="n">cols</span><span class="p">,</span> <span class="n">evnt</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">evnt</span> <span class="ow">in</span> <span class="n">df</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="nn">/tmp/ipython-input-984611419.py</span> in <span class="ni">&lt;cell line: 0&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span> <span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span> 
<span class="ne">---&gt; </span><span class="mi">25</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">8</span><span class="p">)(</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span>     <span class="n">delayed</span><span class="p">(</span><span class="n">make_patch_numba</span><span class="p">)(</span><span class="n">evnt</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">evnt</span><span class="o">.</span><span class="n">cols</span><span class="p">,</span> <span class="n">evnt</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span>     <span class="k">for</span> <span class="n">evnt</span> <span class="ow">in</span> <span class="n">df</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/joblib/parallel.py</span> in <span class="ni">__call__</span><span class="nt">(self, iterable)</span>
<span class="g g-Whitespace">   </span><span class="mi">2070</span>         <span class="nb">next</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2071</span> 
<span class="ne">-&gt; </span><span class="mi">2072</span>         <span class="k">return</span> <span class="n">output</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_generator</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2073</span> 
<span class="g g-Whitespace">   </span><span class="mi">2074</span>     <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/joblib/parallel.py</span> in <span class="ni">_get_outputs</span><span class="nt">(self, iterator, pre_dispatch)</span>
<span class="g g-Whitespace">   </span><span class="mi">1680</span> 
<span class="g g-Whitespace">   </span><span class="mi">1681</span>             <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">retrieval_context</span><span class="p">():</span>
<span class="ne">-&gt; </span><span class="mi">1682</span>                 <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1683</span> 
<span class="g g-Whitespace">   </span><span class="mi">1684</span>         <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/joblib/parallel.py</span> in <span class="ni">_retrieve</span><span class="nt">(self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1782</span>             <span class="c1"># worker traceback.</span>
<span class="g g-Whitespace">   </span><span class="mi">1783</span>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aborting</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1784</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">_raise_error_fast</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1785</span>                 <span class="k">break</span>
<span class="g g-Whitespace">   </span><span class="mi">1786</span> 

<span class="nn">/usr/local/lib/python3.12/dist-packages/joblib/parallel.py</span> in <span class="ni">_raise_error_fast</span><span class="nt">(self)</span>
<span class="g g-Whitespace">   </span><span class="mi">1857</span>         <span class="c1"># called directly or if the generator is gc&#39;ed.</span>
<span class="g g-Whitespace">   </span><span class="mi">1858</span>         <span class="k">if</span> <span class="n">error_job</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1859</span>             <span class="n">error_job</span><span class="o">.</span><span class="n">get_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1860</span> 
<span class="g g-Whitespace">   </span><span class="mi">1861</span>     <span class="k">def</span><span class="w"> </span><span class="nf">_warn_exit_early</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/joblib/parallel.py</span> in <span class="ni">get_result</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">756</span>             <span class="c1"># callback thread, and is stored internally. It&#39;s just waiting to</span>
<span class="g g-Whitespace">    </span><span class="mi">757</span>             <span class="c1"># be returned.</span>
<span class="ne">--&gt; </span><span class="mi">758</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_or_raise</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">759</span> 
<span class="g g-Whitespace">    </span><span class="mi">760</span>         <span class="c1"># For other backends, the main thread needs to run the retrieval step.</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/joblib/parallel.py</span> in <span class="ni">_return_or_raise</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">771</span>         <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">772</span>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">TASK_ERROR</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">773</span>                 <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span>
<span class="g g-Whitespace">    </span><span class="mi">774</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span>
<span class="g g-Whitespace">    </span><span class="mi">775</span>         <span class="k">finally</span><span class="p">:</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/joblib/parallel.py</span> in <span class="ni">dispatch_one_batch</span><span class="nt">(self, iterator)</span>
<span class="g g-Whitespace">   </span><span class="mi">1491</span> 
<span class="g g-Whitespace">   </span><span class="mi">1492</span>                 <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1493</span>                     <span class="n">islice</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">big_batch_size</span><span class="p">))</span>
<span class="g g-Whitespace">   </span><span class="mi">1494</span>                 <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1495</span>                     <span class="c1"># Handle the fact that the generator of task raised an</span>

<span class="nn">/tmp/ipython-input-984611419.py</span> in <span class="ni">&lt;genexpr&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span> 
<span class="g g-Whitespace">     </span><span class="mi">25</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">8</span><span class="p">)(</span>
<span class="ne">---&gt; </span><span class="mi">26</span>     <span class="n">delayed</span><span class="p">(</span><span class="n">make_patch_numba</span><span class="p">)(</span><span class="n">evnt</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">evnt</span><span class="o">.</span><span class="n">cols</span><span class="p">,</span> <span class="n">evnt</span><span class="o">.</span><span class="n">energies</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span>     <span class="k">for</span> <span class="n">evnt</span> <span class="ow">in</span> <span class="n">df</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span> <span class="p">)</span>

<span class="ne">AttributeError</span>: &#39;str&#39; object has no attribute &#39;rows&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="looking-at-distributions">
<h1>Looking at distributions<a class="headerlink" href="#looking-at-distributions" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">photons</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;isNeutralShower&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
<span class="n">charged</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;isChargedShower&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
<span class="n">splitOffs</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;isSplitOff&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;thrownPID&#39;, &#39;thrownEnergy&#39;, &#39;thrownMass&#39;, &#39;showerE&#39;, &#39;rows&#39;, &#39;cols&#39;,
       &#39;energies&#39;, &#39;isSplitOff&#39;, &#39;isChargedShower&#39;, &#39;isNeutralShower&#39;, &#39;E1E9&#39;,
       &#39;E9E25&#39;, &#39;sumU&#39;, &#39;sumV&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">photons_nhits</span> <span class="o">=</span> <span class="n">photons</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span>
<span class="n">charged_nhits</span> <span class="o">=</span> <span class="n">charged</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span>
<span class="n">splitOffs_nhits</span> <span class="o">=</span> <span class="n">splitOffs</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span>

<span class="n">showerE_photons</span> <span class="o">=</span> <span class="n">photons</span><span class="p">[</span><span class="s1">&#39;showerE&#39;</span><span class="p">]</span>
<span class="n">showerE_charged</span> <span class="o">=</span> <span class="n">charged</span><span class="p">[</span><span class="s1">&#39;showerE&#39;</span><span class="p">]</span>
<span class="n">showerE_splitOffs</span> <span class="o">=</span> <span class="n">splitOffs</span><span class="p">[</span><span class="s1">&#39;showerE&#39;</span><span class="p">]</span>

<span class="n">showerE1E9_photons</span> <span class="o">=</span> <span class="n">photons</span><span class="p">[</span><span class="s1">&#39;E1E9&#39;</span><span class="p">]</span>
<span class="n">showerE1E9_charged</span> <span class="o">=</span> <span class="n">charged</span><span class="p">[</span><span class="s1">&#39;E1E9&#39;</span><span class="p">]</span>
<span class="n">showerE1E9_splitOffs</span> <span class="o">=</span> <span class="n">splitOffs</span><span class="p">[</span><span class="s1">&#39;E1E9&#39;</span><span class="p">]</span>

<span class="n">showerE9E25_photons</span> <span class="o">=</span> <span class="n">photons</span><span class="p">[</span><span class="s1">&#39;E9E25&#39;</span><span class="p">]</span>
<span class="n">showerE9E25_charged</span> <span class="o">=</span> <span class="n">charged</span><span class="p">[</span><span class="s1">&#39;E9E25&#39;</span><span class="p">]</span>
<span class="n">showerE9E25_splitOffs</span> <span class="o">=</span> <span class="n">splitOffs</span><span class="p">[</span><span class="s1">&#39;E9E25&#39;</span><span class="p">]</span>

<span class="n">showerU_photons</span> <span class="o">=</span> <span class="n">photons</span><span class="p">[</span><span class="s1">&#39;sumU&#39;</span><span class="p">]</span>
<span class="n">showerU_charged</span> <span class="o">=</span> <span class="n">charged</span><span class="p">[</span><span class="s1">&#39;sumU&#39;</span><span class="p">]</span>
<span class="n">showerU_splitOffs</span> <span class="o">=</span> <span class="n">splitOffs</span><span class="p">[</span><span class="s1">&#39;sumU&#39;</span><span class="p">]</span>

<span class="n">showerV_photons</span> <span class="o">=</span> <span class="n">photons</span><span class="p">[</span><span class="s1">&#39;sumV&#39;</span><span class="p">]</span>
<span class="n">showerV_charged</span> <span class="o">=</span> <span class="n">charged</span><span class="p">[</span><span class="s1">&#39;sumV&#39;</span><span class="p">]</span>
<span class="n">showerV_splitOffs</span> <span class="o">=</span> <span class="n">splitOffs</span><span class="p">[</span><span class="s1">&#39;sumV&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">photons</span><span class="p">[</span><span class="s2">&quot;cols&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">photons</span><span class="p">[</span><span class="s2">&quot;cols&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">photons</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">photons</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 58
0 58
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.45</span><span class="p">,</span> <span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">})</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerE_photons</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;photons&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerE_charged</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;charged&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerE_splitOffs</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;splitOffs&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Shower Energy [GeV]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Normalized Counts&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">photons_nhits</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;photons&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">charged_nhits</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;charged&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">splitOffs_nhits</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;splitOffs&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Number of Hits&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Normalized Counts&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerE1E9_photons</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;photons&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerE1E9_charged</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;charged&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerE1E9_splitOffs</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;splitOffs&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;E1E9&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Normalized Counts&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerE9E25_photons</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;photons&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerE9E25_charged</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;charged&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerE9E25_splitOffs</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;splitOffs&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;E9E25&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Normalized Counts&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerU_photons</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">15.</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;photons&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerU_charged</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">15.</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;charged&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerU_splitOffs</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">15.</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;splitOffs&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;sumU&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Normalized Counts&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerV_photons</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">15.</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;photons&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerV_charged</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">15.</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;charged&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">showerV_splitOffs</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">15.</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;splitOffs&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;sumV&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fada1713fe719058315da98a95842f7cc7f66f458b7becb1acce965091482645.png" src="../_images/fada1713fe719058315da98a95842f7cc7f66f458b7becb1acce965091482645.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lets make a HitMap of all the hits.</span>

<span class="n">FCAL_GEOMETRY</span> <span class="o">=</span> <span class="p">(</span><span class="mi">59</span><span class="p">,</span> <span class="mi">59</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">MakeHitMap</span><span class="p">(</span><span class="n">evnt</span><span class="p">,</span> <span class="n">min_hits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">evnt</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_hits</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
  <span class="n">matrix_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">FCAL_GEOMETRY</span><span class="p">)</span>
  <span class="n">matrix_energies</span><span class="p">[</span><span class="n">evnt</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">evnt</span><span class="o">.</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">evnt</span><span class="o">.</span><span class="n">energies</span>
  <span class="k">return</span> <span class="n">matrix_energies</span>

<span class="c1"># Lets draw a few images side by side</span>
<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;isNeutralShower&quot;</span><span class="p">,</span> <span class="s2">&quot;isChargedShower&quot;</span><span class="p">,</span> <span class="s2">&quot;isSplitOff&quot;</span><span class="p">]</span>
<span class="n">NROWS</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">NCOLS</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span> <span class="o">=</span> <span class="n">NROWS</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">NCOLS</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>

<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NROWS</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NCOLS</span><span class="p">):</span>
    <span class="n">evt</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">r</span> <span class="o">*</span> <span class="n">NCOLS</span> <span class="o">+</span> <span class="n">c</span><span class="p">]</span>
    <span class="n">hitmap</span> <span class="o">=</span> <span class="n">MakeHitMap</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hitmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
    <span class="c1">#axs[r, c].matshow(hitmap, cmap=&#39;hot&#39;, origin = &quot;lower&quot;)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">hitmap</span><span class="p">)</span>

    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">evt</span><span class="o">.</span><span class="n">isNeutralShower</span><span class="p">:</span>
      <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot;NeutralShower&quot;</span>
    <span class="k">elif</span> <span class="n">evt</span><span class="o">.</span><span class="n">isChargedShower</span><span class="p">:</span>
      <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot;ChargedShower&quot;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot;SplitOff&quot;</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Class: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">, E: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">r</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">NCOLS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">thrownEnergy</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> GeV&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b68a64d37fca7f249382bea5842a1fffe46d0f82990f4dd4a4e11d59183e5f48.png" src="../_images/b68a64d37fca7f249382bea5842a1fffe46d0f82990f4dd4a4e11d59183e5f48.png" />
</div>
</div>
</section>
<section id="distinguishing-split-offs-from-photons">
<h1>Distinguishing Split-offs from Photons<a class="headerlink" href="#distinguishing-split-offs-from-photons" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ================== FAST TRAINER FOR SPLIT-OFF vs PHOTON (fixed dtypes + AMP API) ==================</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">math</span><span class="o">,</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span><span class="o">,</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span><span class="p">,</span> <span class="n">trange</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span><span class="o">,</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">TensorDataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">nullcontext</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># Config</span>
<span class="c1"># ---------------------------</span>
<span class="n">WINDOW_SIZE</span>   <span class="o">=</span> <span class="mi">11</span>      <span class="c1"># 11x11 crop around seed (no rotations/flips)</span>
<span class="n">ONE_BASED</span>     <span class="o">=</span> <span class="kc">False</span>   <span class="c1"># set True if rows/cols are 1..59</span>
<span class="n">ENERGY_SCALE</span>  <span class="o">=</span> <span class="mf">0.05</span>    <span class="c1"># GeV (for global log scaling)</span>
<span class="n">CLIP_MAX</span>      <span class="o">=</span> <span class="mf">2.0</span>     <span class="c1"># GeV per cell clamp for scaling</span>
<span class="n">BATCH_SIZE</span>    <span class="o">=</span> <span class="mi">512</span>
<span class="n">EPOCHS</span>        <span class="o">=</span> <span class="mi">15</span>
<span class="n">LR</span>            <span class="o">=</span> <span class="mf">3e-4</span>
<span class="n">VAL_FRAC</span>      <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">TEST_FRAC</span>     <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">DEVICE</span>        <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span>
<span class="n">USE_AMP</span>       <span class="o">=</span> <span class="p">(</span><span class="n">DEVICE</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">)</span>   <span class="c1"># automatic mixed precision only on CUDA</span>

<span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">set_float32_matmul_precision</span><span class="p">(</span><span class="s2">&quot;medium&quot;</span><span class="p">)</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># Precompute fixed windows</span>
<span class="c1"># ---------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_dense_from_hits</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="n">H</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">W</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">e</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">M</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_crop_pad_around_seed</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">M</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="n">r0</span><span class="p">,</span> <span class="n">c0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">half</span> <span class="o">=</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">-</span> <span class="n">half</span><span class="p">,</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">half</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">c0</span> <span class="o">-</span> <span class="n">half</span><span class="p">,</span> <span class="n">c0</span> <span class="o">+</span> <span class="n">half</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">r1s</span><span class="p">,</span> <span class="n">c1s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r2s</span><span class="p">,</span> <span class="n">c2s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">r1d</span><span class="p">,</span> <span class="n">c1d</span> <span class="o">=</span> <span class="n">r1s</span> <span class="o">-</span> <span class="n">r1</span><span class="p">,</span> <span class="n">c1s</span> <span class="o">-</span> <span class="n">c1</span>
    <span class="n">r2d</span><span class="p">,</span> <span class="n">c2d</span> <span class="o">=</span> <span class="n">r1d</span> <span class="o">+</span> <span class="p">(</span><span class="n">r2s</span> <span class="o">-</span> <span class="n">r1s</span><span class="p">),</span> <span class="n">c1d</span> <span class="o">+</span> <span class="p">(</span><span class="n">c2s</span> <span class="o">-</span> <span class="n">c1s</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="n">r1d</span><span class="p">:</span><span class="n">r2d</span><span class="p">,</span> <span class="n">c1d</span><span class="p">:</span><span class="n">c2d</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r1s</span><span class="p">:</span><span class="n">r2s</span><span class="p">,</span> <span class="n">c1s</span><span class="p">:</span><span class="n">c2s</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_log_global_norm</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">e0</span><span class="o">=</span><span class="n">ENERGY_SCALE</span><span class="p">,</span> <span class="n">emax</span><span class="o">=</span><span class="n">CLIP_MAX</span><span class="p">):</span>
    <span class="c1"># Keep everything float32 to avoid silent upcasts to float64</span>
    <span class="n">W</span>    <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">e0</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">e0</span><span class="p">)</span>
    <span class="n">emax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">emax</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">W</span> <span class="o">/</span> <span class="n">e0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">emax</span> <span class="o">/</span> <span class="n">e0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">Z</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Z</span>  <span class="c1"># float32</span>

<span class="k">def</span><span class="w"> </span><span class="nf">prepare_windows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">WINDOW_SIZE</span><span class="p">,</span> <span class="n">one_based</span><span class="o">=</span><span class="n">ONE_BASED</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;isSplitOff&quot;</span><span class="p">,</span> <span class="s2">&quot;isNeutralShower&quot;</span><span class="p">,</span> <span class="s2">&quot;isChargedShower&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

    <span class="n">photons</span>   <span class="o">=</span> <span class="n">d</span><span class="p">[(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;isNeutralShower&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;isSplitOff&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;isChargedShower&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))]</span>
    <span class="n">splitoffs</span> <span class="o">=</span> <span class="n">d</span><span class="p">[(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;isSplitOff&quot;</span><span class="p">])]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">photons</span><span class="p">,</span> <span class="n">splitoffs</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">y</span>    <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;isSplitOff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 0=photon, 1=splitoff</span>

    <span class="n">X_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Precomputing windows&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bar</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cols&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">one_based</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">c</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">_dense_from_hits</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">crop</span> <span class="o">=</span> <span class="n">_crop_pad_around_seed</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">crop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">window</span><span class="p">,</span> <span class="n">window</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">X_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_log_global_norm</span><span class="p">(</span><span class="n">crop</span><span class="p">))</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># (N, H, W), float32</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>                                         <span class="c1"># (N, 1, H, W)</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># Model</span>
<span class="c1"># ---------------------------</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SmallCNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_ch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_ch</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">n_classes</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># Dataloaders</span>
<span class="c1"># ---------------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make_single_loader_from_arrays</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">num_workers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
  <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
  <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

  <span class="n">Xtr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
  <span class="n">ytr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

  <span class="n">train_ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">ytr</span><span class="p">)</span>

  <span class="n">nw</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
  <span class="n">pin</span> <span class="o">=</span> <span class="p">(</span><span class="n">DEVICE</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">)</span>

  <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">num_workers</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">train_loader</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make_loaders_from_arrays</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">n_test</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">TEST_FRAC</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">n_val</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">VAL_FRAC</span>  <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">n_train</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">n_val</span> <span class="o">-</span> <span class="n">n_test</span>
    <span class="n">i_train</span><span class="p">,</span> <span class="n">i_val</span><span class="p">,</span> <span class="n">i_test</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="n">n_train</span><span class="p">:</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_val</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="n">n_train</span><span class="o">+</span><span class="n">n_val</span><span class="p">:]</span>

    <span class="c1"># Ensure tensors are float32 / int64</span>
    <span class="n">Xtr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i_train</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Xva</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i_val</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">Xte</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i_test</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ytr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i_train</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">yva</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i_val</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">yte</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i_test</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

    <span class="n">train_ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">ytr</span><span class="p">)</span>
    <span class="n">val_ds</span>   <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">Xva</span><span class="p">,</span> <span class="n">yva</span><span class="p">)</span>
    <span class="n">test_ds</span>  <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">Xte</span><span class="p">,</span> <span class="n">yte</span><span class="p">)</span>

    <span class="n">nw</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">pin</span> <span class="o">=</span> <span class="p">(</span><span class="n">DEVICE</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span><span class="p">)</span>

    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">num_workers</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">val_loader</span>   <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_ds</span><span class="p">,</span>   <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">num_workers</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">test_loader</span>  <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_ds</span><span class="p">,</span>  <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">num_workers</span><span class="o">=</span><span class="n">nw</span><span class="p">,</span> <span class="n">pin_memory</span><span class="o">=</span><span class="n">pin</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span>

<span class="c1"># ---------------------------</span>
<span class="c1"># Eval &amp; Train (with progress bars + new AMP)</span>
<span class="c1"># ---------------------------</span>
<span class="nd">@torch</span><span class="o">.</span><span class="n">inference_mode</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Eval&quot;</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">ys</span><span class="p">,</span> <span class="n">ps</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">bar</span><span class="p">:</span>
        <span class="n">Xb</span> <span class="o">=</span> <span class="n">Xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">yb</span> <span class="o">=</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">Xb</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">());</span> <span class="n">ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prob</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">yb</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">();</span> <span class="n">total</span> <span class="o">+=</span> <span class="n">yb</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">acc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">correct</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">total</span><span class="p">))</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="k">if</span> <span class="n">ys</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">y_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span> <span class="k">if</span> <span class="n">ps</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
    <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span> <span class="k">if</span> <span class="n">y_true</span><span class="o">.</span><span class="n">size</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">acc</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span>

<span class="k">def</span><span class="w"> </span><span class="nf">train_fast</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="c1"># 1) Precompute windows</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">prepare_windows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">WINDOW_SIZE</span><span class="p">,</span> <span class="n">ONE_BASED</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prepared windows: </span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, photons=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">, splitoffs=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 2) Dataloaders</span>
    <span class="n">train_loader</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">make_loaders_from_arrays</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">)</span>

    <span class="c1"># 3) Model, optimizer, class-weighted loss</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SmallCNN</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">opt</span>   <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LR</span><span class="p">)</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">((</span><span class="n">counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">counts</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">crit</span>  <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>

    <span class="n">scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">USE_AMP</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># 4) Train</span>
    <span class="n">best_auc</span><span class="p">,</span> <span class="n">best_state</span><span class="p">,</span> <span class="n">patience</span><span class="p">,</span> <span class="n">bad</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">EPOCHS</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Training&quot;</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">running</span><span class="p">,</span> <span class="n">seen</span><span class="p">,</span> <span class="n">correct</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">EPOCHS</span><span class="si">}</span><span class="s2"> (train)&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">bar</span><span class="p">:</span>
            <span class="n">Xb</span> <span class="o">=</span> <span class="n">Xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">yb</span> <span class="o">=</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span> <span class="k">if</span> <span class="n">USE_AMP</span> <span class="k">else</span> <span class="n">nullcontext</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">ctx</span><span class="p">:</span>
                <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">Xb</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">crit</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">USE_AMP</span><span class="p">:</span>
                <span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
                <span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="n">running</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">seen</span>    <span class="o">+=</span> <span class="n">yb</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">yb</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">avg_loss</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">running</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">seen</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">correct</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">seen</span><span class="p">))</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">train_loss</span> <span class="o">=</span> <span class="n">running</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">seen</span><span class="p">)</span>
        <span class="n">val_acc</span><span class="p">,</span> <span class="n">val_auc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">EPOCHS</span><span class="si">}</span><span class="s2"> (val)&quot;</span><span class="p">)</span>
        <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2"> | train_loss </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | val_acc </span><span class="si">{</span><span class="n">val_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | val_auc </span><span class="si">{</span><span class="n">val_auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val_auc</span><span class="p">)</span> <span class="k">else</span> <span class="n">val_auc</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_auc</span><span class="p">:</span>
            <span class="n">best_auc</span><span class="p">,</span> <span class="n">bad</span> <span class="o">=</span> <span class="n">score</span><span class="p">,</span> <span class="mi">0</span>
            <span class="n">best_state</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ New best AUC </span><span class="si">{</span><span class="n">best_auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bad</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">bad</span> <span class="o">&gt;=</span> <span class="n">patience</span><span class="p">:</span>
                <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Early stopping.&quot;</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="k">if</span> <span class="n">best_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">best_state</span><span class="p">)</span>

    <span class="c1"># 5) Test</span>
    <span class="n">test_acc</span><span class="p">,</span> <span class="n">test_auc</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="p">(</span><span class="n">y_prob</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test | acc </span><span class="si">{</span><span class="n">test_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | auc </span><span class="si">{</span><span class="n">test_auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Confusion matrix [rows=true, cols=pred] (0=photon,1=splitoff):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span>

<span class="c1"># ---- run it ----</span>
<span class="c1"># model = train_fast(df)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span> <span class="o">=</span> <span class="n">train_fast</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "c99044d2239c42d1aa93496fd2f4f26c"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Prepared windows: (814151, 1, 11, 11), photons=434845, splitoffs=379306
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "b9582d72c1b2428fbc21fd6e9db41fc6"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "00633089762e4d69950add69f602c62e"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "e91c1af5f99746979c7ad35ac5a39777"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 01 | train_loss 0.2722 | val_acc 0.8965 | val_auc 0.9583
✓ New best AUC 0.9583
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "b36eb08364a84ed4b1018dcfccf687bc"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "bdc7bcab4bc64a72a2db1919714b6b05"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 02 | train_loss 0.2580 | val_acc 0.8999 | val_auc 0.9597
✓ New best AUC 0.9597
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "e9142b2d23eb478bbc6eac702a624cfb"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "e0cc138d31a84968a27a6aa644b63332"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 03 | train_loss 0.2547 | val_acc 0.9000 | val_auc 0.9602
✓ New best AUC 0.9602
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "4437b5280ecb4eb685e90922f82e01cc"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "655e2588943e4c099eb25e09a4dd3f3d"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 04 | train_loss 0.2530 | val_acc 0.9005 | val_auc 0.9605
✓ New best AUC 0.9605
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "39f9e480def147888b79eaacca1efa16"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "e346bf97cc6f4c47af9baa6ffa3f1800"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 05 | train_loss 0.2517 | val_acc 0.9015 | val_auc 0.9608
✓ New best AUC 0.9608
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "7feab879fbe64cf792d9ad8325c37d4e"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "f28b998b53ef47fa9a0fe81c51e02c0e"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 06 | train_loss 0.2507 | val_acc 0.9017 | val_auc 0.9612
✓ New best AUC 0.9612
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "beb58cde5a8f4a22a15868734ad363a2"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "68008ee418f84cd283f5454b4466dec5"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 07 | train_loss 0.2499 | val_acc 0.9018 | val_auc 0.9611
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "6d7cad61cdae41f79e77c89f0827c0d7"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "56fe903ce41544bd937ae4c1646168c9"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 08 | train_loss 0.2492 | val_acc 0.9011 | val_auc 0.9616
✓ New best AUC 0.9616
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "201ee2038169468aa36cdcc358346c7e"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "1c6e8deb030945b6bc2fd5a2b6a7bcc4"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 09 | train_loss 0.2486 | val_acc 0.9027 | val_auc 0.9615
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "c35418026c0a4fb8934ac3bb734cbd69"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "a5ce9dbde60c4833a19951ec6314b2c0"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 10 | train_loss 0.2479 | val_acc 0.9021 | val_auc 0.9618
✓ New best AUC 0.9618
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "2c5dc5900bde4baf93c120f146562b84"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "db3e10677c4b4fb3852c87d0a7cae8a1"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 11 | train_loss 0.2474 | val_acc 0.9030 | val_auc 0.9618
✓ New best AUC 0.9618
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "7f4a9354255347498fbd0a8aaa9c11d5"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "ab5b81d006c042d89da2aaaafa677585"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 12 | train_loss 0.2467 | val_acc 0.9026 | val_auc 0.9619
✓ New best AUC 0.9619
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "7deec16ddbbd40ceaac30cd383fee16e"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "0a21881379594f6d870e82337594b842"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 13 | train_loss 0.2466 | val_acc 0.9022 | val_auc 0.9622
✓ New best AUC 0.9622
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "07d929ead1ab4c39acaf8aede9c2ae31"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "1f26b0cd53d24cc4a1229ec9035982b7"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 14 | train_loss 0.2460 | val_acc 0.9024 | val_auc 0.9620
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "562a22778ce545638f22efc286e71731"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "3065e42809d043fa89a818e158766359"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 15 | train_loss 0.2454 | val_acc 0.9032 | val_auc 0.9621
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "84b851a577b44eeaa8015a5185d003d8"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test | acc 0.9022 | auc 0.9620
Confusion matrix [rows=true, cols=pred] (0=photon,1=splitoff):
 [[38435  4987]
 [ 2979 35014]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SmallCNN(
  (net): Sequential(
    (0): Conv2d(1, 16, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (1): BatchNorm2d(16, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): ReLU(inplace=True)
    (3): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (4): Conv2d(16, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (5): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (6): ReLU(inplace=True)
    (7): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (8): Conv2d(32, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (9): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (10): ReLU(inplace=True)
    (11): AdaptiveAvgPool2d(output_size=1)
  )
  (head): Linear(in_features=64, out_features=2, bias=True)
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reference values from https://arxiv.org/pdf/2002.09530</span>
<span class="c1"># 85% signal with 60% background rejection</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">confusion_matrix</span>

<span class="c1"># y_true: 0 = photon (signal), 1 = split-off (background)</span>
<span class="c1"># y_prob: model score = P(split-off)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">eff_rej_at_threshold</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">,</span> <span class="n">thr</span><span class="p">):</span>
    <span class="n">y_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">y_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_prob</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">keep_photon</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_prob</span> <span class="o">&lt;</span> <span class="n">thr</span><span class="p">)</span>
    <span class="n">Nsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span> <span class="n">Nbkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">eps_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_true</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">keep_photon</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nsig</span><span class="p">)</span>
    <span class="n">rej_bkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_true</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">keep_photon</span><span class="p">))</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nbkg</span><span class="p">)</span>  <span class="c1"># predicted split-off</span>

    <span class="c1"># Predicted label: 1=split-off, 0=photon (consistent with y_true)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_prob</span> <span class="o">&gt;=</span> <span class="n">thr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">eps_sig</span><span class="p">,</span> <span class="n">rej_bkg</span><span class="p">,</span> <span class="n">cm</span>

<span class="k">def</span><span class="w"> </span><span class="nf">eff_rej_curve</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">):</span>
    <span class="c1"># Standard ROC for positive class = split-off (1)</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thrs</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Map to your physics metrics:</span>
    <span class="n">eps_sig</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">fpr</span>   <span class="c1"># photon efficiency</span>
    <span class="n">rej_bkg</span> <span class="o">=</span> <span class="n">tpr</span>         <span class="c1"># split-off rejection</span>
    <span class="k">return</span> <span class="n">eps_sig</span><span class="p">,</span> <span class="n">rej_bkg</span><span class="p">,</span> <span class="n">thrs</span>

<span class="c1"># --- Example usage ---</span>
<span class="c1"># If you have them already from evaluate():</span>
<span class="c1"># y_true, y_prob = &lt;from your test set&gt;</span>

<span class="c1"># 1) Curve over all thresholds</span>
<span class="n">eps_sig</span><span class="p">,</span> <span class="n">rej_bkg</span><span class="p">,</span> <span class="n">thrs</span> <span class="o">=</span> <span class="n">eff_rej_curve</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>

<span class="c1"># 2) Pick a working point: match Barsotti–Shepherd ε_sig ≈ 0.85</span>
<span class="n">target_eps</span> <span class="o">=</span> <span class="mf">0.85</span>
<span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eps_sig</span> <span class="o">-</span> <span class="n">target_eps</span><span class="p">)))</span>
<span class="n">thr_star</span> <span class="o">=</span> <span class="n">thrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="n">eps_star</span><span class="p">,</span> <span class="n">rej_star</span><span class="p">,</span> <span class="n">cm_star</span> <span class="o">=</span> <span class="n">eff_rej_at_threshold</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">,</span> <span class="n">thr_star</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Working point (ε_sig≈</span><span class="si">{</span><span class="n">target_eps</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  threshold = </span><span class="si">{</span><span class="n">thr_star</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ε_sig (photon eff)   = </span><span class="si">{</span><span class="n">eps_star</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  R_bkg (split-off rej)= </span><span class="si">{</span><span class="n">rej_star</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Confusion matrix [rows=true, cols=pred] (0=photon,1=splitoff):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cm_star</span><span class="p">)</span>

<span class="c1"># 3) If you just want your current threshold, e.g. t=0.5:</span>
<span class="n">eps_05</span><span class="p">,</span> <span class="n">rej_05</span><span class="p">,</span> <span class="n">cm_05</span> <span class="o">=</span> <span class="n">eff_rej_at_threshold</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">At t=0.50: ε_sig=</span><span class="si">{</span><span class="n">eps_05</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, R_bkg=</span><span class="si">{</span><span class="n">rej_05</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Working point (ε_sig≈0.85):
  threshold = 0.3529
  ε_sig (photon eff)   = 0.8499
  R_bkg (split-off rej)= 0.9426
  Confusion matrix [rows=true, cols=pred] (0=photon,1=splitoff):
[[36906  6516]
 [ 2182 35811]]

At t=0.50: ε_sig=0.8852, R_bkg=0.9216
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eps_sig</span><span class="p">,</span> <span class="n">rej_bkg</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Photon efficiency (ε_sig)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Split-off rejection (R_bkg)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/500a53c5809a3027335de28990dcb12707bced17d55794d3129bd5bdf1f53790.png" src="../_images/500a53c5809a3027335de28990dcb12707bced17d55794d3129bd5bdf1f53790.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lets try with Omega</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">uproot</span><span class="o">,</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span><span class="o">,</span><span class="w"> </span><span class="nn">awkward</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ak</span><span class="o">,</span><span class="w"> </span><span class="nn">vector</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span><span class="o">,</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">vector</span><span class="o">.</span><span class="n">register_awkward</span><span class="p">()</span>


<span class="n">omega_path</span> <span class="o">=</span> <span class="s2">&quot;/content/drive/MyDrive/DNP-2025/OmegaExclusive/OmegaExclusive.root&quot;</span>
<span class="n">omega_tree</span> <span class="o">=</span> <span class="n">uproot</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">omega_path</span><span class="p">)[</span><span class="s2">&quot;OmegaSampleTree&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">omega_tree</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">branch</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="n">branch</span><span class="o">.</span><span class="n">typename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>thrownPiPlus of type TLorentzVector
thrownPiMinus of type TLorentzVector
thrownRecoilProton of type TLorentzVector
thrownPi0 of type TLorentzVector
reconPiPlus of type TLorentzVector
reconPiMinus of type TLorentzVector
reconRecoilProton of type TLorentzVector
thrownBeam of type TLorentzVector
thrownOmegaMass of type double
rows of type std::vector&lt;int32_t&gt;
cols of type std::vector&lt;int32_t&gt;
energies of type std::vector&lt;double&gt;
times of type std::vector&lt;double&gt;
nShowers of type int32_t
showerT of type std::vector&lt;double&gt;
numBlocks of type std::vector&lt;int32_t&gt;
showerE of type std::vector&lt;double&gt;
sumU of type std::vector&lt;double&gt;
sumV of type std::vector&lt;double&gt;
E9E25 of type std::vector&lt;double&gt;
E1E9 of type std::vector&lt;double&gt;
nHitsPerShower of type std::vector&lt;int32_t&gt;
startIndexPerShower of type std::vector&lt;int32_t&gt;
FCALNeutralShowerPx of type std::vector&lt;double&gt;
FCALNeutralShowerPy of type std::vector&lt;double&gt;
FCALNeutralShowerPz of type std::vector&lt;double&gt;
FCALNeutralShowerE of type std::vector&lt;double&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lets convert the tree into array</span>
<span class="n">tree_ak</span> <span class="o">=</span> <span class="n">omega_tree</span><span class="o">.</span><span class="n">arrays</span><span class="p">(</span><span class="n">library</span><span class="o">=</span><span class="s2">&quot;ak&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">tree_ak</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>24814
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># lets go through events and makeShowerHitMaps</span>

<span class="k">def</span><span class="w"> </span><span class="nf">MakeShowerHitMaps</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">FCAL_GEOM</span> <span class="o">=</span> <span class="p">(</span><span class="mi">59</span><span class="p">,</span> <span class="mi">59</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
  <span class="n">nShowers</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">nShowers</span>
  <span class="n">matrix_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nShowers</span><span class="p">,</span> <span class="o">*</span><span class="n">FCAL_GEOM</span><span class="p">))</span>
  <span class="n">FourVectors</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nShowers</span><span class="p">):</span>
    <span class="n">start_idx</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">startIndexPerShower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">event</span><span class="o">.</span><span class="n">nHitsPerShower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">matrix_energies</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">rows</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">],</span> <span class="n">event</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">energies</span> <span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
    <span class="c1"># lets make a radius and center of shower to draw it.</span>
    <span class="n">lorentzVector</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">obj</span><span class="p">(</span>
        <span class="n">px</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">FCALNeutralShowerPx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">py</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">FCALNeutralShowerPy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">pz</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">FCALNeutralShowerPz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">FCALNeutralShowerE</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">FourVectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lorentzVector</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;hitmap&quot;</span> <span class="p">:</span> <span class="n">matrix_energies</span><span class="p">,</span> <span class="s2">&quot;4vector&quot;</span> <span class="p">:</span>  <span class="n">FourVectors</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># lets get into a inference pipeline</span>

<span class="k">def</span><span class="w"> </span><span class="nf">make4Vector</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">vector</span><span class="o">.</span><span class="n">obj</span><span class="p">(</span>
      <span class="n">px</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">fP</span><span class="o">.</span><span class="n">fX</span><span class="p">,</span>
      <span class="n">py</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">fP</span><span class="o">.</span><span class="n">fY</span><span class="p">,</span>
      <span class="n">pz</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">fP</span><span class="o">.</span><span class="n">fZ</span><span class="p">,</span>
      <span class="n">E</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">fE</span>
  <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">runInference</span><span class="p">(</span><span class="n">hitMap</span><span class="p">,</span> <span class="n">energy</span><span class="p">):</span>
  <span class="s2">&quot;do inference using CNN, an example of returning True 50</span><span class="si">% o</span><span class="s2">f time. Here energy is simply used as a hard cut&quot;</span>
  <span class="k">return</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">energy</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="kc">True</span>

<span class="n">reco_pi0Mass</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">reco_omegaMass</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">_device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">_device</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="n">tree_ak</span><span class="p">:</span>
  <span class="n">HitMapDict</span> <span class="o">=</span> <span class="n">MakeShowerHitMaps</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
  <span class="n">goodShowers</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">hitMap</span><span class="p">,</span> <span class="n">fourVector</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">HitMapDict</span><span class="p">[</span><span class="s2">&quot;hitmap&quot;</span><span class="p">],</span> <span class="n">HitMapDict</span><span class="p">[</span><span class="s2">&quot;4vector&quot;</span><span class="p">]):</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">hitMap</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pred</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">goodShowers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fourVector</span><span class="p">)</span>
  <span class="n">piplus</span> <span class="o">=</span> <span class="n">make4Vector</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">thrownPiPlus</span><span class="p">)</span>
  <span class="n">piminus</span> <span class="o">=</span> <span class="n">make4Vector</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">thrownPiMinus</span><span class="p">)</span>
  <span class="n">pi0</span> <span class="o">=</span> <span class="n">goodShowers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">goodShowers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">reco_pi0Mass</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pi0</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
  <span class="n">reco_omegaMass</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pi0</span> <span class="o">+</span> <span class="n">piplus</span> <span class="o">+</span> <span class="n">piminus</span><span class="p">)</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="nn">/tmp/ipython-input-4181544179.py</span> in <span class="ni">&lt;cell line: 0&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span>   <span class="n">goodShowers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span>   <span class="k">for</span> <span class="n">hitMap</span><span class="p">,</span> <span class="n">fourVector</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">HitMapDict</span><span class="p">[</span><span class="s2">&quot;hitmap&quot;</span><span class="p">],</span> <span class="n">HitMapDict</span><span class="p">[</span><span class="s2">&quot;4vector&quot;</span><span class="p">]):</span>
<span class="ne">---&gt; </span><span class="mi">24</span>     <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">hitMap</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>     <span class="n">pred</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span>     <span class="k">if</span> <span class="n">pred</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/torch/nn/modules/module.py</span> in <span class="ni">_wrapped_call_impl</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1771</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_call_impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>
<span class="g g-Whitespace">   </span><span class="mi">1772</span>         <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1773</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1774</span> 
<span class="g g-Whitespace">   </span><span class="mi">1775</span>     <span class="c1"># torchrec tests the code consistency with the following code</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/torch/nn/modules/module.py</span> in <span class="ni">_call_impl</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1782</span>                 <span class="ow">or</span> <span class="n">_global_backward_pre_hooks</span> <span class="ow">or</span> <span class="n">_global_backward_hooks</span>
<span class="g g-Whitespace">   </span><span class="mi">1783</span>                 <span class="ow">or</span> <span class="n">_global_forward_hooks</span> <span class="ow">or</span> <span class="n">_global_forward_pre_hooks</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1784</span>             <span class="k">return</span> <span class="n">forward_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1785</span> 
<span class="g g-Whitespace">   </span><span class="mi">1786</span>         <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nn">/tmp/ipython-input-2098387309.py</span> in <span class="ni">forward</span><span class="nt">(self, x)</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span>         <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">n_classes</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">107</span>     <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">108</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span> 
<span class="g g-Whitespace">    </span><span class="mi">110</span> <span class="c1"># ---------------------------</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/torch/nn/modules/module.py</span> in <span class="ni">_wrapped_call_impl</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1771</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_call_impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>
<span class="g g-Whitespace">   </span><span class="mi">1772</span>         <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1773</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1774</span> 
<span class="g g-Whitespace">   </span><span class="mi">1775</span>     <span class="c1"># torchrec tests the code consistency with the following code</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/torch/nn/modules/module.py</span> in <span class="ni">_call_impl</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1782</span>                 <span class="ow">or</span> <span class="n">_global_backward_pre_hooks</span> <span class="ow">or</span> <span class="n">_global_backward_hooks</span>
<span class="g g-Whitespace">   </span><span class="mi">1783</span>                 <span class="ow">or</span> <span class="n">_global_forward_hooks</span> <span class="ow">or</span> <span class="n">_global_forward_pre_hooks</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1784</span>             <span class="k">return</span> <span class="n">forward_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1785</span> 
<span class="g g-Whitespace">   </span><span class="mi">1786</span>         <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/torch/nn/modules/container.py</span> in <span class="ni">forward</span><span class="nt">(self, input)</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">243</span>         <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">244</span>             <span class="nb">input</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>         <span class="k">return</span> <span class="nb">input</span>
<span class="g g-Whitespace">    </span><span class="mi">246</span> 

<span class="nn">/usr/local/lib/python3.12/dist-packages/torch/nn/modules/module.py</span> in <span class="ni">_wrapped_call_impl</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1771</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_call_impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>
<span class="g g-Whitespace">   </span><span class="mi">1772</span>         <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1773</span>             <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_impl</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1774</span> 
<span class="g g-Whitespace">   </span><span class="mi">1775</span>     <span class="c1"># torchrec tests the code consistency with the following code</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/torch/nn/modules/module.py</span> in <span class="ni">_call_impl</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1782</span>                 <span class="ow">or</span> <span class="n">_global_backward_pre_hooks</span> <span class="ow">or</span> <span class="n">_global_backward_hooks</span>
<span class="g g-Whitespace">   </span><span class="mi">1783</span>                 <span class="ow">or</span> <span class="n">_global_forward_hooks</span> <span class="ow">or</span> <span class="n">_global_forward_pre_hooks</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1784</span>             <span class="k">return</span> <span class="n">forward_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1785</span> 
<span class="g g-Whitespace">   </span><span class="mi">1786</span>         <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/torch/nn/modules/batchnorm.py</span> in <span class="ni">forward</span><span class="nt">(self, input)</span>
<span class="g g-Whitespace">    </span><span class="mi">158</span> 
<span class="g g-Whitespace">    </span><span class="mi">159</span>     <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">160</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_check_input_dim</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">161</span> 
<span class="g g-Whitespace">    </span><span class="mi">162</span>         <span class="c1"># exponential_average_factor is set to self.momentum</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/torch/nn/modules/batchnorm.py</span> in <span class="ni">_check_input_dim</span><span class="nt">(self, input)</span>
<span class="g g-Whitespace">    </span><span class="mi">450</span>     <span class="k">def</span><span class="w"> </span><span class="nf">_check_input_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">451</span>         <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">452</span>             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;expected 4D input (got </span><span class="si">{</span><span class="nb">input</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="si">}</span><span class="s2">D input)&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">453</span> 
<span class="g g-Whitespace">    </span><span class="mi">454</span> 

<span class="ne">ValueError</span>: expected 4D input (got 3D input)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># lets plot in bins of momentum to see how the model performs</span>

<span class="n">momentum_bins</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.500</span><span class="p">,</span> <span class="mf">0.750</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">]</span>

</pre></div>
</div>
</div>
</div>
</section>
<section id="regression">
<h1>Regression<a class="headerlink" href="#regression" title="Link to this heading">#</a></h1>
<section id="apply-the-classifier-build-dataset-of-predicted-photons">
<h2>Apply the classifier – build dataset of predicted photons<a class="headerlink" href="#apply-the-classifier-build-dataset-of-predicted-photons" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Choose which rows to score (recommended: neutral candidates only)</span>
<span class="n">to_score</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;isChargedShower&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thrownEnergy&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)]</span>  <span class="c1"># or add &quot;&amp; (df[&#39;isNeutralShower&#39;]==True)&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_windows_for</span><span class="p">(</span><span class="n">df_subset</span><span class="p">):</span>
    <span class="n">X_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">df_subset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_subset</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Windows for scoring&quot;</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;rows&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;cols&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ONE_BASED</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">c</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">_dense_from_hits</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">crop</span> <span class="o">=</span> <span class="n">_crop_pad_around_seed</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">WINDOW_SIZE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">crop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">WINDOW_SIZE</span><span class="p">,</span> <span class="n">WINDOW_SIZE</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">X_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_log_global_norm</span><span class="p">(</span><span class="n">crop</span><span class="p">))</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">X</span>

<span class="n">X_all</span> <span class="o">=</span> <span class="n">build_windows_for</span><span class="p">(</span><span class="n">to_score</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">predict_splitoff_prob</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">xb</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Scoring&quot;</span><span class="p">):</span>
            <span class="n">xb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># P(split-off)</span>
            <span class="n">probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>

<span class="c1"># Pick a threshold:</span>
<span class="c1"># - t=0.5 (default), or</span>
<span class="c1"># - the threshold that gave ε_sig≈0.85 when you matched Barsotti–Shepherd</span>
<span class="n">t</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">p_split</span> <span class="o">=</span> <span class="n">predict_splitoff_prob</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span> <span class="n">X_all</span><span class="p">)</span>
<span class="n">pred_is_photon</span> <span class="o">=</span> <span class="n">p_split</span> <span class="o">&lt;</span> <span class="n">t</span>

<span class="c1"># ----- DATASET 1: predicted photons -----</span>
<span class="n">dataset1</span> <span class="o">=</span> <span class="n">to_score</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pred_is_photon</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">dataset1</span><span class="p">[</span><span class="s2">&quot;p_splitoff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_split</span><span class="p">[</span><span class="n">pred_is_photon</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "b115eb7ec606409bbe46f1e6c7b8dcc3"}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exception ignored in: &lt;function _MultiProcessingDataLoaderIter.__del__ at 0x7f9c39d29300&gt;
Traceback (most recent call last):
  File &quot;/usr/local/lib/python3.12/dist-packages/torch/utils/data/dataloader.py&quot;, line 1664, in __del__
    self._shutdown_workers()
  File &quot;/usr/local/lib/python3.12/dist-packages/torch/utils/data/dataloader.py&quot;, line 1628, in _shutdown_workers
    w.join(timeout=_utils.MP_STATUS_CHECK_INTERVAL)
  File &quot;/usr/lib/python3.12/multiprocessing/process.py&quot;, line 149, in join
    res = self._popen.wait(timeout)
          ^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/lib/python3.12/multiprocessing/popen_fork.py&quot;, line 40, in wait
    if not wait([self.sentinel], timeout):
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/lib/python3.12/multiprocessing/connection.py&quot;, line 1136, in wait
    ready = selector.select(timeout)
            ^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/lib/python3.12/selectors.py&quot;, line 415, in select
    fd_event_list = self._selector.poll(timeout)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
KeyboardInterrupt: 
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "5f2fbf62f7d849f3b695a3c980150cc3"}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X_all</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">atest_acc</span><span class="p">,</span> <span class="n">atest_auc</span><span class="p">,</span> <span class="n">ay_true</span><span class="p">,</span> <span class="n">ay_prob</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
<span class="n">acm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">ay_true</span><span class="p">,</span> <span class="p">(</span><span class="n">ay_prob</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test | acc </span><span class="si">{</span><span class="n">atest_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | auc </span><span class="si">{</span><span class="n">atest_auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Confusion matrix [rows=true, cols=pred] (0=photon,1=splitoff):</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">acm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "7a677a540b504afa8465b16ba5007ee3"}</script><div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="nn">/tmp/ipython-input-484292637.py</span> in <span class="ni">&lt;cell line: 0&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X_all</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">atest_acc</span><span class="p">,</span> <span class="n">atest_auc</span><span class="p">,</span> <span class="n">ay_true</span><span class="p">,</span> <span class="n">ay_prob</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">acm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">ay_true</span><span class="p">,</span> <span class="p">(</span><span class="n">ay_prob</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test | acc </span><span class="si">{</span><span class="n">atest_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> | auc </span><span class="si">{</span><span class="n">atest_auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nn">/usr/local/lib/python3.12/dist-packages/torch/utils/_contextlib.py</span> in <span class="ni">decorate_context</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>     <span class="k">def</span><span class="w"> </span><span class="nf">decorate_context</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span>         <span class="k">with</span> <span class="n">ctx_factory</span><span class="p">():</span>
<span class="ne">--&gt; </span><span class="mi">120</span>             <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span> 
<span class="g g-Whitespace">    </span><span class="mi">122</span>     <span class="k">return</span> <span class="n">decorate_context</span>

<span class="nn">/tmp/ipython-input-2098387309.py</span> in <span class="ni">evaluate</span><span class="nt">(model, loader, desc)</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span>     <span class="n">correct</span> <span class="o">=</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="g g-Whitespace">    </span><span class="mi">152</span>     <span class="n">bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">153</span>     <span class="k">for</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">bar</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">154</span>         <span class="n">Xb</span> <span class="o">=</span> <span class="n">Xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">155</span>         <span class="n">yb</span> <span class="o">=</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="ne">ValueError</span>: not enough values to unpack (expected 2, got 1)
</pre></div>
</div>
</div>
</div>
</section>
<section id="truth-matched-photons-and-purity">
<h2>Truth-matched photons and purity<a class="headerlink" href="#truth-matched-photons-and-purity" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># dataset2: predicted ∧ truth photons (intersection)</span>
<span class="n">dataset2</span> <span class="o">=</span> <span class="n">dataset1</span><span class="p">[</span><span class="n">dataset1</span><span class="p">[</span><span class="s2">&quot;thrownPID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">22</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># --------- Efficiencies (two denominators) ---------</span>
<span class="n">truth_all_mask</span>    <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;thrownPID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">22</span><span class="p">)</span>
<span class="n">truth_scored_mask</span> <span class="o">=</span> <span class="n">to_score</span><span class="p">[</span><span class="s2">&quot;thrownPID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">22</span>

<span class="n">N_truth_all</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">truth_all_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="n">N_truth_scored</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">truth_scored_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

<span class="c1"># efficiency relative to ALL truth photons in df  (what you printed before)</span>
<span class="n">eff_global</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_truth_all</span><span class="p">)</span>

<span class="c1"># efficiency relative to TRUTH PHOTONS INSIDE THE SCORED SET (ROC-consistent)</span>
<span class="n">eff_scored</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_truth_scored</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Truth photons in df:         </span><span class="si">{</span><span class="n">N_truth_all</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Truth photons that were scored: </span><span class="si">{</span><span class="n">N_truth_scored</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal efficiency (global)  = </span><span class="si">{</span><span class="n">eff_global</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal efficiency (scored)  = </span><span class="si">{</span><span class="n">eff_scored</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">  &lt;-- compare this to ROC&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Truth photons in df:         512141
Truth photons that were scored: 512141
Signal efficiency (global)  = 0.8130
Signal efficiency (scored)  = 0.8130  &lt;-- compare this to ROC
</pre></div>
</div>
</div>
</div>
</section>
<section id="train-regressor-on-all-truth-photons">
<h2>Train Regressor on all Truth Photons<a class="headerlink" href="#train-regressor-on-all-truth-photons" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Build windows/targets for all truth photons</span>
<span class="n">truth_photons</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;isNeutralShower&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
<span class="n">X_reg</span> <span class="o">=</span> <span class="n">build_windows_for</span><span class="p">(</span><span class="n">truth_photons</span><span class="p">)</span>
<span class="n">y_reg</span> <span class="o">=</span> <span class="n">truth_photons</span><span class="p">[</span><span class="s2">&quot;thrownEnergy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># GeV</span>

<span class="c1"># Train/val split (stratify by energy bins for stability)</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">y_reg</span> <span class="o">/</span> <span class="mf">0.25</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># ~250 MeV bins</span>
<span class="n">i_tr</span><span class="p">,</span> <span class="n">i_va</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_reg</span><span class="p">)),</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

<span class="n">tr_ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X_reg</span><span class="p">[</span><span class="n">i_tr</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                      <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_reg</span><span class="p">[</span><span class="n">i_tr</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">va_ds</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">X_reg</span><span class="p">[</span><span class="n">i_va</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                      <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y_reg</span><span class="p">[</span><span class="n">i_va</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="n">tr_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">tr_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">va_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">va_ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Small CNN regressor</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SmallCNNReg</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_ch</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_ch</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># predict energy in GeV</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">reg</span> <span class="o">=</span> <span class="n">SmallCNNReg</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">3e-4</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SmoothL1Loss</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># Huber; robust to tails</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">trange</span>
<span class="n">best_va</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="mf">1e9</span><span class="p">,</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Regressor training&quot;</span><span class="p">):</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">tr_loader</span><span class="p">:</span>
        <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">reg</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">();</span> <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="n">reg</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">va_err</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="ow">in</span> <span class="n">va_loader</span><span class="p">:</span>
            <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span> <span class="n">yb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">reg</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span>
            <span class="n">va_err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">l1_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>  <span class="c1"># MAE</span>
        <span class="n">mae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">va_err</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">mae</span> <span class="o">&lt;</span> <span class="n">best_va</span><span class="p">:</span>
        <span class="n">best_va</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="n">mae</span><span class="p">,</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">reg</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ new best MAE </span><span class="si">{</span><span class="n">best_va</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> GeV&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">reg</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">best</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "308f5b00708c4024b4db7d7b7c4c39e0"}</script><script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "60c41784493e4adbaa56fbe148f238e5"}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  ✓ new best MAE 0.152 GeV
  ✓ new best MAE 0.148 GeV
  ✓ new best MAE 0.145 GeV
  ✓ new best MAE 0.145 GeV
  ✓ new best MAE 0.141 GeV
  ✓ new best MAE 0.141 GeV
  ✓ new best MAE 0.140 GeV
  ✓ new best MAE 0.139 GeV
  ✓ new best MAE 0.138 GeV
  ✓ new best MAE 0.137 GeV
  ✓ new best MAE 0.137 GeV
  ✓ new best MAE 0.137 GeV
</pre></div>
</div>
</div>
</div>
</section>
<section id="deploy-regressor-on-dataset-1-showers-classified-as-photons-and-dataset-2-true-photons-and-plot-reconstructed-energy">
<h2>Deploy Regressor on Dataset 1 (showers classified as photons) and Dataset 2 (true photons) and Plot Reconstructed Energy<a class="headerlink" href="#deploy-regressor-on-dataset-1-showers-classified-as-photons-and-dataset-2-true-photons-and-plot-reconstructed-energy" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">regress_on_df</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
    <span class="c1">#X = build_windows_for(df_subset)</span>
    <span class="c1">#ds = TensorDataset(torch.from_numpy(X).to(torch.float32))</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">E_true</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Regressing&quot;</span><span class="p">):</span>
            <span class="n">xb</span> <span class="o">=</span> <span class="n">xb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">xb</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">E_true</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="n">E_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
    <span class="n">E_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">E_true</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">E_pred</span><span class="p">,</span> <span class="n">E_true</span>

<span class="c1"># Apply to dataset 1 (predicted photons)</span>
<span class="n">Epred_1</span><span class="p">,</span> <span class="n">Etrue_1</span> <span class="o">=</span> <span class="n">regress_on_df</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">va_ds</span><span class="p">)</span>

<span class="c1"># Apply to dataset 2 (truth photons)</span>
<span class="c1">#Epred_2, Etrue_2 = regress_on_df(reg, dataset2)</span>

<span class="c1"># --- Plots: predicted vs true ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">scatter_pred_true</span><span class="p">(</span><span class="n">E_pred</span><span class="p">,</span> <span class="n">E_true</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">E_true</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: no thrownEnergy available.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">E_true</span><span class="p">,</span> <span class="n">E_pred</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">([</span><span class="n">E_true</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">E_pred</span><span class="o">.</span><span class="n">max</span><span class="p">()]))))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;True energy [GeV]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Regressed energy [GeV]&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">scatter_pred_true</span><span class="p">(</span><span class="n">Epred_1</span><span class="p">,</span> <span class="n">Etrue_1</span><span class="p">,</span> <span class="s2">&quot;Validation Dataset (predicted photons): E_pred vs E_true&quot;</span><span class="p">)</span>
<span class="c1">#scatter_pred_true(Epred_2, Etrue_2, &quot;Dataset 2 (truth photons): E_pred vs E_true&quot;)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "923d68ebea7c4a25ae0d86ad5b7fbacb"}</script><img alt="../_images/668cf3238814ef8189cb9bd28b77a4ca8ccc9e06919b6a8589096bee5122c220.png" src="../_images/668cf3238814ef8189cb9bd28b77a4ca8ccc9e06919b6a8589096bee5122c220.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="02-cnn-classification.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">CNN for FCAL Shower Classification</p>
      </div>
    </a>
    <a class="right-next"
       href="03-gan-generation.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">GAN Generation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Data Generation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#fcalshowers-tree">FCALShowers tree</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#looking-at-distributions">Looking at distributions</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#distinguishing-split-offs-from-photons">Distinguishing Split-offs from Photons</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#regression">Regression</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-the-classifier-build-dataset-of-predicted-photons">Apply the classifier – build dataset of predicted photons</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#truth-matched-photons-and-purity">Truth-matched photons and purity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-regressor-on-all-truth-photons">Train Regressor on all Truth Photons</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deploy-regressor-on-dataset-1-showers-classified-as-photons-and-dataset-2-true-photons-and-plot-reconstructed-energy">Deploy Regressor on Dataset 1 (showers classified as photons) and Dataset 2 (true photons) and Plot Reconstructed Energy</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Karthik Suresh & Cristiano Fanelli
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>